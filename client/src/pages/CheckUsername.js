import { useState } from 'react'
import { Typography, Box, Button, Input, Alert } from "@mui/material" 
import { Controller, useForm } from 'react-hook-form'
import BreachDetails from '../components/BreachDetails'
import request from '../api'
const CheckUsername = () => {
  const [isLoading, setIsLoading] = useState(false) 
  const [error, setError] = useState()
  const [hasFetched, setHasFetched] = useState(false)
  const [userBreaches, setUserBreaches] = useState({}) 
  const { control, handleSubmit, getValues } = useForm({
    defaultValues: {
      username: ''
    }
  })

  const handlOnSubmit = async (data) => { 
    setUserBreaches({})
    setHasFetched(false)
    setError(false)
    try{
      const username = data?.username
      const response = await request({ route: `/check-username?user=${username}` })
      setUserBreaches(response) 
      setHasFetched(true)

    } catch(e) {
      setError(e.message)
    }
  }

  const {username} = getValues()
  const breachCount = userBreaches?.count
  const breaches = userBreaches?.details || []
 
  
  return (
    <Box>
      <Typography component='h1' variant='h5' >Check Username</Typography>
      <Box>
        <Typography>Use the form to check and see if you username has been compromised in any known security breaches.</Typography>
        <Box
          component='form'
          onSubmit={handleSubmit(handlOnSubmit)}
          sx={{
            mt: 8,
            display: 'flex',
            justifyContent: 'center'
          }}
        >
          <Controller
            name="username"
            control={control}
            render={({ field }) => <Input placeholder="Username" {...field} />}
          />
          <Button type='submit'>Check</Button>
        </Box>
        {error && <Alert severity="error">{error}</Alert>}
          <Box mt={2}>
            {hasFetched && <Typography component='h1' variant='h5' >{ breachCount > 0 ? `${username} has been found in ${breachCount} security leaks` : `${username} has not been found in any security leaks.`}</Typography>}
              <Box mt={2}>
                {breaches?.map((breach) =>(
                  <BreachDetails breach={breach} key={breach.id}/>
                ))}
              </Box>
          </Box>
      </Box>
    </Box>
  )
}

export default CheckUsername